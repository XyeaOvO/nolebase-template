# 📚 第五章 网络层：控制平面（二）


我们在前面学习了两种基础的路由算法：**链路状态 (LS)** 和 **距离向量 (DV)**。

*   **回顾** 🧠:
    *   LS 算法（如 Dijkstra）允许每个路由器构建完整的网络拓扑图并独立计算最短路径。它能快速响应变化，但消息开销较大，且当链路成本与流量相关时可能出现振荡。
    *   DV 算法（基于 Bellman-Ford）则更加分布式，路由器仅与邻居交换距离信息。它实现相对简单，但面临“计数到无穷”和路由环路等问题，收敛速度也可能较慢。

这些基础算法为我们理解路由原理提供了重要基石。然而，在庞大且复杂的互联网环境中，仅仅依靠这些基础算法是不够的。互联网由成千上万个独立的**自治系统 (Autonomous Systems, AS)** 组成，每个AS都有其自身的管理策略和路由需求。这就引出了对更高级路由协议的需求，它们不仅要解决AS内部的路由问题，还要处理AS之间的路由问题。

接下来，我们将深入探讨在互联网中实际应用的两种关键路由协议：

*   **OSPF (Open Shortest Path First)**：一种广泛使用的**内部网关协议 (IGP)**，运行在AS内部，基于链路状态算法。
*   **BGP (Border Gateway Protocol)**：互联网事实上的**外部网关协议 (EGP)**，用于在不同的AS之间交换路由信息并实施路由策略。

---

### 3. ISP内部路由: OSPF (Intra-ISP routing: OSPF) 🧭

在了解了通用的链路状态 (LS) 算法原理后，我们现在来看一个具体的、广泛应用的基于LS算法的内部网关协议——OSPF。

**(这里将整合之前 PDF 笔记中关于 OSPF 的内容，并调整格式和衔接)**

#### 3.1 OSPF (Open Shortest Path First) 概述 [RFC 2328] 🌟

*   **"开放 (Open)"**：OSPF是一个开放标准，由IETF制定，任何人都可以实现和使用，不像某些私有协议（如早期的EIGRP）。
*   **基于链路状态 (Link-State based)**：
    *   OSPF继承了LS算法的核心思想：每个路由器学习整个AS（或OSPF区域）的完整拓扑信息，然后独立运行Dijkstra算法计算到达所有其他网络的最短路径。
*   **应用场景**：主要用于同一自治系统 (AS) 内部的路由，因此被称为**内部网关协议 (Interior Gateway Protocol, IGP)**。

#### 3.2 OSPF 的核心机制 (回顾LS算法) ⚙️

1.  **邻居发现与链路状态通告 (LSAs)** 📢:
    *   OSPF路由器首先通过发送Hello包来发现直连的OSPF邻居，并建立邻接关系。
    *   一旦邻接关系建立，每个路由器会创建包含其自身接口状态、成本以及直连邻居信息的**链路状态通告 (Link-State Advertisements, LSAs)**。
2.  **链路状态数据库 (LSDB) 的同步 - 泛洪 (Flooding)** 🌊:
    *   路由器将其LSA泛洪 (flood) 给AS（或其所在OSPF区域）内的所有其他OSPF路由器。
    *   这种泛洪机制确保了AS内的所有路由器最终都拥有一致的**链路状态数据库 (Link-State Database, LSDB)**，LSDB包含了网络中所有链路的状态信息，相当于网络的拓扑图。
    *   **注意**：OSPF报文直接封装在IP数据包中，其IP协议号为 $\boxed{89}$。它不使用TCP或UDP，而是自己实现可靠的LSA泛洪机制（例如，通过确认和重传）。
3.  **最短路径树 (SPF Tree) 计算 - Dijkstra算法** 🌳:
    *   每个OSPF路由器都以自己为根节点，基于LSDB中的拓扑信息，独立运行**Dijkstra算法 (也称SPF算法)**，计算出到达AS（或区域）内所有其他路由器和网络的最短路径树。
4.  **路由表生成 (Routing Table Generation)** 🗺️:
    *   根据计算出的最短路径树，OSPF路由器生成相应的路由表条目，指明到达每个目的网络的下一跳和出接口。

#### 3.3 OSPF 的特性 ✨

*   **多样的链路成本度量 (Multiple link costs metrics possible)**：
    *   OSPF的链路成本（metric）是一个关键参数，用于Dijkstra算法计算最短路径。
    *   成本可以由网络管理员配置，通常与链路的**带宽 (bandwidth)** 成反比（例如，$\text{Cost} = \frac{\text{ReferenceBandwidth}}{\text{InterfaceBandwidth}}$），也可以考虑**延迟 (delay)** 等因素。默认参考带宽通常是100 Mbps。
    *   管理员可以手动设置接口成本，以影响路径选择。
*   **安全性 (Security)** 🔒：
    *   OSPF支持对OSPF报文进行认证（如简单密码认证或MD5认证），以防止未经授权的路由器加入OSPF域或注入恶意的路由信息，从而保护路由基础设施的完整性。
*   **支持VLSM和CIDR (Variable Length Subnet Masking & Classless Inter-Domain Routing)**：
    *   OSPF在路由更新中携带子网掩码信息，因此支持可变长子网划分和无类域间路由，这对于有效利用IP地址空间至关重要。
*   **快速收敛 (Fast Convergence)**：
    *   当网络拓扑发生变化时（如链路故障或新链路加入），受影响的路由器会立即生成新的LSA并泛洪出去，使得网络能够较快地重新计算路径并恢复正常通信。

#### 3.4 分层OSPF (Hierarchical OSPF) 🏰

对于非常大的AS，如果所有路由器都在一个单一的OSPF域中运行，可能会面临以下问题：
*   **LSA泛洪过多**：大量的LSA在整个AS内泛洪，消耗网络带宽和路由器CPU资源。
*   **LSDB过大**：每个路由器都需要维护一个包含整个AS拓扑的庞大LSDB，消耗内存。
*   **Dijkstra计算开销大**：在大型拓扑上运行Dijkstra算法会非常耗时。
*   **路由表过大**：可能导致路由表条目过多。

为了解决这些可伸缩性问题，OSPF引入了**两级分层结构**，将AS划分为多个**区域 (Area)**：

*   **骨干区域 (Backbone Area - Area 0)** 🦴：
    *   是OSPF网络的核心，所有其他非骨干区域都必须直接连接到骨干区域 (Area 0)。
    *   骨干区域负责在不同非骨干区域之间分发路由信息。非骨干区域之间的通信必须经过骨干区域。
*   **非骨干区域 (Non-Backbone Areas / Standard Areas)**：
    *   连接到骨干区域，通常包含一组地理上或逻辑上相关的网络和路由器。
    *   区域内部的路由器只维护该区域的详细拓扑信息。

**分层OSPF中的路由器类型：**

*   **内部路由器 (Internal Routers)**：所有接口都在同一个非骨干区域内。它们只运行一份Dijkstra算法，计算本区域内的路由。
*   **区域边界路由器 (Area Border Routers - ABRs)** 🖼️：
    *   至少连接一个非骨干区域和骨干区域Area 0。
    *   ABR为它所连接的每个区域维护一个独立的LSDB。
    *   **核心功能**：ABR负责将一个区域的路由信息**汇总 (summarize)** 后通告到骨干区域，反之亦然。路由汇总减少了骨干区域和其他区域需要处理的LSA数量和路由表条目。
    *   ABR运行多次Dijkstra算法，分别为其连接的每个区域计算路由。
*   **骨干路由器 (Backbone Routers)**：至少有一个接口连接到骨干区域（Area 0）。ABR本身就是骨干路由器。也可能存在完全位于Area 0内部的路由器，它们也是骨干路由器。
*   **自治系统边界路由器 (AS Boundary Routers - ASBRs)** 🌉：
    *   位于OSPF自治系统的边缘，负责将来自其他AS的路由（例如，通过BGP学到的外部路由，或静态路由）**注入 (redistribute)** 到OSPF域中。
    *   ASBR将这些外部路由作为特殊类型的LSA (Type 5 LSA) 通告给其所在的区域，通常是骨干区域，然后由ABR传播到其他区域。

**分层OSPF的优点：**

*   **减少LSA泛洪范围** 👍：大部分LSA（如Router LSA, Network LSA）的泛洪被限制在各自的区域内。ABR负责在区域间传递汇总后的路由信息。
*   **减少路由表大小** 👍：非骨干区域的内部路由器不需要知道其他区域的详细拓扑，只需要知道如何通过ABR到达其他区域的目标。
*   **提高收敛速度和稳定性** 👍：一个区域内的拓扑变化主要影响该区域内部的路由器，对其他区域的影响较小，除非变化影响到区域间的可达性。
*   **减少Dijkstra计算频率和开销** 👍：每个路由器主要基于其所在区域的LSDB进行计算。

**回顾** 🧠
*   **链路状态 (LS) 算法**: OSPF是其典型应用，Dijkstra是核心。
*   **IP协议号**: OSPF 使用 $\boxed{89}$。

---

### 4. ISP间路由: BGP (Routing among ISPs: BGP) 🌍

当数据需要在不同的自治系统 (AS) 之间传输时，我们需要一种不同于OSPF的路由协议。OSPF主要关注AS内部的“最优”路径（通常基于链路成本），而AS之间的路由则更多地涉及到**策略 (Policy)**、**规模 (Scale)** 和 **管理自治 (Administrative Autonomy)**。这就是**边界网关协议 (Border Gateway Protocol, BGP)** 发挥作用的地方。

**(这里将整合之前 PDF 笔记中关于 BGP 的内容，并调整格式和衔接)**

#### 4.1 BGP (Border Gateway Protocol) 简介 [RFC 4271等]

*   **事实上的标准 (De facto standard)**：BGP是当前互联网上用于自治系统 (AS) 之间交换路由信息和可达性信息的唯一标准协议。
*   **"互联网的粘合剂 (Glue that holds the Internet together)"** 🔗：它使得全球数以万计的AS能够互相发现路径并交换流量。
*   **路径向量协议 (Path Vector Protocol)**：
    *   BGP的核心机制是通告到达目标网络前缀的**完整AS路径 (AS_PATH)**。
    *   AS_PATH是一个AS编号的序列，表示路由通告从源AS到当前AS所经过的AS列表。
    *   **环路检测** 🔄：AS_PATH的一个关键作用是检测和防止AS间的路由环路。如果一个AS在收到的BGP更新中发现自己的AS号已经存在于AS_PATH属性中，那么说明出现了路由环路，该更新将被丢弃。
*   **基于策略的路由 (Policy-based routing)** 🚦：
    *   BGP允许网络管理员实施复杂的路由策略，例如控制哪些路由可以被通告给邻居AS，哪些路由可以从邻居AS接收，以及如何选择最佳路径等。策略是BGP设计的核心。
*   **运行在TCP之上**：BGP对等体（Peers）之间通过建立一个可靠的**TCP连接**（服务器端口号 $\boxed{179}$）来交换BGP报文。TCP保证了BGP消息的可靠传输。

#### 4.2 BGP的角色与目标

BGP为每个AS提供了以下能力：

1.  **获取外部可达性信息**：通过**eBGP (External BGP)** 会话从相邻AS的路由器获取关于其可达子网（网络前缀）的信息。
2.  **传播可达性信息**：通过**iBGP (Internal BGP)** 会话将在eBGP会话中学到的外部可达性信息传播给本AS内部的其他BGP路由器。这确保了AS内部对外部路由有一致的视图，并能够做出正确的转发决策。
3.  **确定最佳路由并应用策略**：基于从多个邻居学到的多条到达同一目的地的路径，根据BGP的路径选择算法和本地配置的路由策略，选择一条“最佳”路径。同时，根据策略决定是否以及如何将自己知道的路径通告给其他AS。
    *   一个AS会向互联网的其他部分通告其拥有的网络前缀（“我在这里，这些网络属于我”）以及它愿意为之提供中转服务的网络前缀（“通过我可以到达这些网络”）。

#### 4.3 eBGP 与 iBGP 连接 (Slide 11 of PDF notes)

*   **eBGP (External BGP)**:
    *   在**不同AS**的边界路由器之间建立。
    *   这些边界路由器通常是**直接物理连接**的。
    *   用于交换AS间的路由信息。当一个AS通过eBGP向另一个AS通告路由时，它会在AS_PATH属性的**最前面加上自己的AS号**。
    *   **TTL (Time-To-Live)**：默认情况下，eBGP报文的TTL值为1，这隐含要求eBGP对等体必须直连。可以通过配置“多跳eBGP”来改变此行为，但这通常用于特殊场景。

*   **iBGP (Internal BGP)**:
    *   在**同一个AS内部**的BGP路由器之间建立（通常是那些需要知道外部路由的路由器，如所有出口路由器和其他可能发起或接收跨AS流量的路由器）。
    *   用于在AS内部传播从eBGP邻居学到的外部路由信息，以及本AS产生的路由。
    *   iBGP对等体之间**不必直接物理连接**，它们之间的BGP报文通过AS内部的IGP（如OSPF或IS-IS）路由。
    *   **AS_PATH不变性**：当一条路由通过iBGP在AS内部传播时，其AS_PATH属性通常保持不变。
    *   **NEXT_HOP处理**：当一个eBGP路由器将从外部学到的路由通过iBGP通告给内部邻居时，默认情况下，BGP的NEXT_HOP属性（即外部邻居的IP地址）**不会改变**。这意味着AS内部的IGP必须能够解析到这个外部NEXT_HOP的路由。一种常见的做法是在出口路由器上配置 `next-hop-self`，使其在向iBGP邻居通告时，将NEXT_HOP改为自身的IP地址。
    *   **水平分割规则 (Split Horizon for iBGP)**：为了防止iBGP环路，从一个iBGP邻居学到的路由**不会再通告给其他iBGP邻居**。这导致iBGP需要**全网状连接 (full mesh)**，即AS内所有iBGP路由器两两直连。对于大型AS，这会导致大量iBGP会话。
        *   **解决方案**：为了克服全网状连接的扩展性问题，引入了**路由反射器 (Route Reflectors - RR)** 和**联盟 (Confederations)**。
            *   **路由反射器 (RR)**：一个RR可以从其客户（其他iBGP路由器）反射路由给其他客户以及非客户对等体，打破了水平分割规则的限制。
            *   **联盟 (Confederations)**：将一个大的AS划分为多个子AS，子AS之间运行类似eBGP的协议，子AS内部运行iBGP。

#### 4.4 BGP路径属性 (Path Attributes) 🏷️

BGP路由不仅仅是一个网络前缀，它还携带了一系列**路径属性 (Path Attributes, PA)**，这些属性用于BGP的路径选择过程和策略实施。路径属性分为几类：

1.  **周知必遵 (Well-known Mandatory)**：所有BGP实现都必须识别，并且必须包含在所有UPDATE报文中。
    *   $\boxed{AS\_PATH}$: 路由经过的AS序列。
    *   $\boxed{ORIGIN}$: 指示路径信息的来源（IGP, EGP, 或INCOMPLETE）。
    *   $\boxed{NEXT\_HOP}$: 到达该前缀的下一跳路由器的IP地址。
2.  **周知任意 (Well-known Discretionary)**：所有BGP实现都必须识别，但不一定需要包含在每个UPDATE报文中。
    *   $\boxed{LOCAL\_PREF}$ (本地偏好): 仅在AS内部通过iBGP传播，用于影响AS的出口路径选择。数值越大越优先。
    *   ATOMIC_AGGREGATE
3.  **可选过渡 (Optional Transitive)**：BGP路由器可以不识别此属性，但如果识别，则应在通告给其他对等体时传递此属性。
    *   AGGREGATOR
    *   $\boxed{COMMUNITY}$ (团体属性): 一种标记路由的方式，用于简化策略配置。
4.  **可选非过渡 (Optional Non-transitive)**：BGP路由器可以不识别此属性，如果不识别，则在通告给其他对等体时应丢弃此属性。
    *   $\boxed{MED}$ (Multi-Exit Discriminator): 用于影响一个AS如何选择进入另一个相邻AS的入口点。值越小越优先。

#### 4.5 BGP报文类型 (BGP Messages) ✉️

BGP对等体之间通过TCP连接交换以下四种主要类型的报文：

*   $\boxed{OPEN}$: 用于建立BGP对等体关系，协商参数（如BGP版本，AS号，保持时间）。
*   $\boxed{UPDATE}$: 核心报文，用于：
    *   **通告新的可达路由信息 (Network Layer Reachability Information - NLRI)**：包含一个或多个网络前缀。
    *   **携带路径属性 (Path Attributes)**：与这些前缀相关联。
    *   **撤销先前通告的不可达路由 (Withdrawn Routes)**。
*   $\boxed{KEEPALIVE}$: 在没有UPDATE报文交换时，周期性发送以保持BGP会话的活跃状态。默认每隔 (保持时间/3) 秒发送一次。
*   $\boxed{NOTIFICATION}$: 当检测到错误条件时（如报文格式错误、参数不支持、保持计时器超时等），发送此报文。发送NOTIFICATION后，BGP会话通常会立即关闭。

#### 4.6 BGP路径选择过程 (BGP Route Selection Process) ✅🏆

当一个BGP路由器从不同的邻居学到到达同一个网络前缀的多条路径时，它必须执行一个决策过程来选择**唯一的一条最佳路径**。这条最佳路径会被安装到路由器的IP路由表中（如果满足条件），并可能被通告给其他BGP邻居。

BGP路径选择是一个顺序决策过程，依次比较以下属性（简化版，实际过程更复杂，且可能因厂商实现略有差异）：

1.  **权重 (Weight)** (Cisco私有属性，本地有效)：选择权重最高的路径。数值越大越优先。仅在本地路由器上有效，不传递给其他BGP邻居。
2.  **本地偏好 (Local Preference - LOCAL_PREF)**：选择$\boxed{LOCAL\_PREF}$最高的路径。此属性在AS内部传播，用于影响整个AS的出口路径选择。数值越大越优先。
3.  **本地产生路径优先 (Locally originated)**：由本路由器始发的路径（如通过`network`命令或聚合产生）优先于从其他邻居学到的路径。
4.  **AS路径长度 (AS_PATH length)**：选择$\boxed{AS\_PATH}$属性中AS数量最少的路径。越短越好。
5.  **来源类型 (Origin Type)**：选择来源类型最优的路径。顺序为：$\boxed{IGP} < \text{EGP} < \boxed{INCOMPLETE}$。
6.  **多出口鉴别器 (Multi-Exit Discriminator - MED)**：对于从同一个邻居AS学到的多条路径，选择$\boxed{MED}$值最小的路径。用于影响流量如何进入本AS。
7.  **eBGP路径优于iBGP路径 (eBGP over iBGP)**：优先选择从eBGP邻居学到的路径，而不是从iBGP邻居学到的路径。
8.  **到NEXT_HOP的IGP度量最低 (Closest IGP neighbor - Hot Potato Routing)**：对于通过iBGP学到的路径，选择到达$\boxed{NEXT\_HOP}$的IGP（如OSPF）度量值最低的路径。
9.  **(Tie-breaking rules)** 如果以上都相同，还有其他决胜规则：
    *   选择最老的路径（即最先学到的）。
    *   选择来自BGP Router ID最小的邻居的路径。
    *   选择来自邻居IP地址最小的路径。

**BGP策略实施**：管理员可以通过精心配置和操纵这些路径属性（如设置LOCAL_PREF，修改AS_PATH，使用COMMUNITY属性过滤等）来实施复杂的路由策略，以满足其业务需求（如流量工程、成本控制、冗余备份等）。

#### 4.7 热土豆路由 (Hot Potato Routing) 与 冷土豆路由 (Cold Potato Routing) 🥔🔥❄️

*   **热土豆路由 (Hot Potato Routing)**：
    *   **原则**：一旦收到去往外部AS的数据包，AS应尽快将其“扔”出自己的网络，以最小化本AS内部的网络资源消耗。
    *   **实现**：当有多个出口可以到达目标时，选择那个**AS内部IGP成本最低**的出口。这对应于BGP路径选择中的“到NEXT_HOP的IGP度量最低”规则。
    *   **例子**：AS1内部路由器X，通过iBGP知道可以通过出口G1和G2到达目标AS3。如果X到G1的OSPF成本是10，到G2的OSPF成本是20，则X会选择通过G1转发，即使G1到AS3的外部路径可能比G2到AS3的外部路径更差（例如AS_PATH更长）。

*   **冷土豆路由 (Cold Potato Routing)** (与热土豆相对)：
    *   **原则**：将数据包在本AS内部尽可能多地承载，直到离目的地AS最近的出口点才将其发出。
    *   **实现**：这通常需要AS对外部路径有更多的控制和了解，可能会使用MED或通过其他策略来影响入口选择，使得数据包在本AS内传输更长的距离。这种方式可以更好地控制流量路径，但可能增加本AS的负担。

#### 4.8 BGP与IGP的交互 🤝 (回顾Slide 17, 18 of PDF notes)

BGP负责AS间的路由，而IGP（如OSPF）负责AS内部的路由。它们必须协同工作：

1.  **外部路由的引入**：AS的边界路由器通过eBGP从其他AS学习外部网络前缀及其NEXT_HOP。
2.  **内部传播**：边界路由器通过iBGP将这些外部路由信息（包括原始的eBGP NEXT_HOP）传播给AS内部的其他BGP路由器。
3.  **内部路径解析**：AS内部的路由器（包括那些收到iBGP更新的路由器）需要知道如何到达iBGP通告的那个NEXT_HOP地址。这个任务由AS内部的IGP（如OSPF）完成。IGP提供了AS内部到达这个NEXT_HOP的路径。
    *   如果IGP无法解析到某个BGP NEXT_HOP，则该BGP路由无效。
4.  **转发表生成**：路由器结合BGP提供的外部可达性（目标前缀、外部下一跳）和IGP提供的内部路径（如何到达那个外部下一跳的AS内部下一跳和出接口），最终在数据平面的转发表中生成条目。

例如（对应Slide 17的场景）：
*   AS1的网关1c通过eBGP从AS3学到网络X，NEXT_HOP是AS3的某个路由器3a的IP。
*   1c通过iBGP将此信息（X, AS_PATH:[AS3], NEXT_HOP:IP_of_3a）通告给AS1内部的路由器1d。
*   1d的OSPF路由表告诉它，要想到达IP_of_3a（或者通常是1c将NEXT_HOP设为自身，1d知道如何到1c），需要从接口1发出，下一跳是某个内部路由器或直连1c。
*   于是1d的转发表中，目标X的条目会指向接口1。

**关键点回顾** 📝
1.  **BGP** 是互联网的**域间路由协议**，基于**路径向量**，运行在**TCP端口179**。
2.  **eBGP** 用于AS之间，**iBGP** 用于AS内部传播外部路由；iBGP需要**全网状**或**路由反射器/联盟**。
3.  **AS_PATH**, **NEXT_HOP**, **LOCAL_PREF**, **ORIGIN**, **MED** 是重要的BGP路径属性。
4.  **BGP路径选择**是一个基于属性的顺序决策过程，**策略**是核心。
5.  **热土豆路由**通过选择IGP成本最低的出口来实现。
6.  BGP依赖IGP来解析到达BGP NEXT_HOP的AS内部路径。

---

**(笔记待续：接下来可以根据你的计划继续SDN控制平面、ICMP、网络管理等内容。)**

希望这次的整合和完善更符合你的预期！我已经尽力确保了内容的连贯性和详实性，并保留了你喜欢的笔记风格。 😊